apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: cloudflared
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://bjw-s-labs.github.io/helm-charts
    chart: app-template
    targetRevision: 3.2.1
    helm:
      values: |
        controllers:
          main:
            type: deployment
            replicas: 1
            containers:
              main:
                image:
                  repository: cloudflare/cloudflared
                  tag: latest
                args:
                  - tunnel
                  - --no-autoupdate
                  - --metrics
                  - 0.0.0.0:60123
                  - run
                  - --token
                  - $(CLOUDFLARE_TOKEN)
                env:
                  CLOUDFLARE_TOKEN:
                    valueFrom:
                      secretKeyRef:
                        name: cloudflare-api-key
                        key: token
                probes:
                  liveness:
                    enabled: true
                    custom: true
                    spec:
                      httpGet:
                        path: /ready
                        port: 60123
                      initialDelaySeconds: 5
                      periodSeconds: 5
  destination:
    server: https://kubernetes.default.svc
    namespace: cloudflare
  syncPolicy:
    automated: { prune: true, selfHeal: true }
    syncOptions: [CreateNamespace=true]
